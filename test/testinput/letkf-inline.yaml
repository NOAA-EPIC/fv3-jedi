geometry:
  fms initialization:
    namelist filename: Data/ModelRunDirs/UFS_warmstart/input.nml
    field table filename: Data/ModelRunDirs/UFS_warmstart/field_table
  akbk: Data/fv3files/akbk127.nc4
  npx: 49
  npy: 49
  npz: 127
  member_number: 0
  layout: [2,1]
  field metadata override: Data/fieldmetadata/ufs.yaml
time window:
  begin: &date 2020-12-14T21:00:00Z
  length: PT6H

Run Inline: true
inline parameters:
  Run Forecast: false
  Forecast configuration:
  - testinput/letkf_forecast_ufs_1.yaml
  - testinput/letkf_forecast_ufs_2.yaml
# - testinput/letkf_forecast_ufs_3.yaml
# - testinput/letkf_forecast_ufs_4.yaml
  Compute HofX Only: false
  forecast batch size: 1
  zero padding: 2
  output file pattern: '%ensmem%'

background:
   members from template:
     template:
       datetime: 2020-12-15T00:00:00Z
       filetype: fms restart
       state variables: [ua,va,t,delp,sphum,ice_wat,liq_wat,o3mr,phis,
                         slmsk,sheleg,tsea,vtype,stype,vfrac,stc,smc,snwdph,
                         u_srf,v_srf,f10m]
       datapath: Data/inputs/gfs_c48/mem%mem%/
       filename_core: 20201215.000000.fv_core.res.nc
       filename_trcr: 20201215.000000.fv_tracer.res.nc
       filename_sfcd: 20201215.000000.sfc_data.nc
       filename_sfcw: 20201215.000000.fv_srf_wnd.res.nc
       filename_cplr: 20201215.000000.coupler.res
     pattern: '%mem%'
     nmembers: 2
     zero padding: 3

observations:
  observers:
  - obs space:
      name: Scatwind
      distribution:
        name: Halo
        halo size: 5000e3
      obsdatain:
        engine:
          type: H5File
#         obsfile: Data/hofx/new/scatwind_letkf-gfs_2020121500_m.nc4
          obsfile: Data/obs/testinput_tier_1/scatwind_obs_2020121500_m.nc4
#         obsfile: Data/hofx/scatwind_letkf-gfs_2020121500_m.nc4
      obsdataout:
        engine:
          type: H5File
          obsfile: Data/hofx/scatwind_letkf-member%ensmem%-gfs_2020121500_m.nc4
      io pool:
        max pool size: 1
        write multiple files: false
      simulated variables: [windEastward, windNorthward]
    obs operator:
      name: VertInterp
      vertical coordinate: air_pressure
      observation vertical coordinate: pressure
#     constant vertical coordinate values: [1.2935175169939301, 2.0560170792448735, 3.2099780369050297, 4.9244806732419182, 7.4260366973539753, 11.013543585839802, 16.071500137597411, 23.083787868446535, 32.648386654790954, 45.488310100060332, 62.460697526384763, 84.561317895515486, 112.92219232016193, 148.80204275141409, 193.57229762559558, 248.69514527559113, 315.69253359218862, 396.1115521407678, 491.48597082105607, 603.29414569570838, 732.91755275460696, 881.60202101128459, 1050.4251776487108, 1240.2720271868166, 1451.8169455507925, 1685.519366494583, 1941.6314328912401, 2220.2141067067346, 2521.1695789439145, 2844.281277684192, 3189.26429058338, 3555.8235721907063, 3943.7179395282828, 4352.8305973202678, 4783.2411552433359, 5235.3026202107412, 5709.7193590381812, 6207.6280350649495, 6730.6822040805109, 7280.9801183099507, 7860.3754245775017, 8470.1714484625445, 9111.5319937207078, 9785.6051896380304, 10493.515338137269, 11236.357871974882, 12015.187800601701, 12831.006019807901, 13684.753130455094, 14577.296446754626, 15509.415719028097, 16481.793919538628, 17495.000854621474, 18549.482791124996, 19645.549693156354, 20783.360624546462, 21962.912418976262, 23184.020358576669, 24446.314118642505, 25749.223809068222, 27091.962477251367, 28473.521850164223, 29892.673147688227, 31347.968196387614, 32837.734253795679, 34360.079963862401, 35912.9035919577, 37493.900382114225, 39100.56206172047, 40730.190954509519, 42379.928743671015, 44046.770141571556, 45727.568100461067, 47419.04976343998, 49117.860488583159, 50820.579110925792, 52523.724837372443, 54223.821528655244, 55917.453189463195, 57601.269873001002, 59271.997271040222, 60926.460552080949, 62561.601889130972, 64174.509936093702, 65762.443226751115, 67322.837665947474, 68853.3191285824, 70351.734150544391, 71816.171235733011, 73244.953298280394, 74636.63137077124, 75989.984868116531, 77304.019985629289, 78577.951877050349, 79811.209605796219, 81003.410119594759, 82154.346759915643, 83263.984124197086, 84332.43799907573, 85359.956632884554, 86346.932463932884, 87293.895375129287, 88201.463141950357, 89070.353478934732, 89901.37697469609, 90695.515852671408, 91453.577028753658, 92176.407533925652, 92865.21472901394, 93521.070459526192, 94145.009661751552, 94738.147410867226, 95301.567790968489, 95836.383145647647, 96343.679354660824, 96824.531097769708, 97280.056348812825, 97711.372091846322, 98119.571775310673, 98505.706679467898, 98870.799047344743, 99215.851778849174, 99541.834120665168, 99849.685975629851, 100140.3127679535, 100414.58133641056, 100673.34640908921]
      observation vertical coordinate group: MetaData
      interpolation method: log-linear
    obs error:
      covariance model: diagonal
    obs localizations:
    - localization method: Horizontal Box car
      lengthscale: 5000e3
      max nobs: 1000
  - obs space:
      name: AMSUA-NOAA19
      distribution:
        name: Halo
        halo size: 5000e3
      obsdatain:
        engine:
          type: H5File
#         obsfile: Data/hofx/new/amsua_n19_letkf-gfs_2020121500_m.nc4
          obsfile: Data/obs/testinput_tier_1/amsua_n19_obs_2020121500_m.nc4
#         obsfile: Data/hofx/amsua_n19_letkf-gfs_2020121500_m.nc4
      obsdataout:
        engine:
          type: H5File
          obsfile: Data/hofx/amsua_n19_letkf-member%ensmem%-gfs_2020121500_m.nc4
      io pool:
        max pool size: 1
        write multiple files: false
      simulated variables: [brightnessTemperature]
      channels: 4-6,9-14
    obs operator:
      name: CRTM
      Absorbers: [H2O,O3]
#       Clouds: [Water, Ice]
#       Cloud_Fraction: 1.0
      obs options:
        Sensor_ID: amsua_n19
        EndianType: little_endian
        CoefficientPath: Data/crtm/
    obs error:
      covariance model: diagonal
    obs filters:
    - filter: Bounds Check
      filter variables:
      - name: brightnessTemperature
        channels: 4-6,9-14
      minvalue: 100.0
      maxvalue: 500.0
    - filter: Background Check
      filter variables:
      - name: brightnessTemperature
        channels: 4-6,9-14
      threshold: 3.0
    obs localizations:
    - localization method: Horizontal Gaspari-Cohn
      lengthscale: 1000e3
      max nobs: 100
  - obs space:
      name: SfcObs
      distribution:
        name: Halo
        halo size: 2000e3
      obsdatain:
        engine:
          type: H5File
#         obsfile: Data/hofx/new/sfc_letkf-gfs_2020121500_m.nc4
          obsfile: Data/obs/testinput_tier_1/sfc_obs_2020121500_m.nc4
#         obsfile: Data/hofx/sfc_letkf-gfs_2020121500_m.nc4
      obsdataout:
        engine:
          type: H5File
          obsfile: Data/hofx/sfc_letkf-member%ensmem%-gfs_2020121500_m.nc4
      simulated variables: [stationPressure]
      io pool:
        max pool size: 1
        write multiple files: false
    obs operator:
      name: SfcPCorrected
      da_psfc_scheme: UKMO
    linear obs operator:
      name: Identity
    obs error:
      covariance model: diagonal
    obs filters:
    - filter: Background Check
      threshold: 1000
    obs localizations:
    - localization method: Horizontal SOAR
      soar horizontal decay: 0.000018
      lengthscale: 2000e3
      max nobs: 1000
  - obs space:
      name: Aircraft
      distribution:
        name: Halo
        halo size: 5000e3
      obsdatain:
        engine:
          type: H5File
#         obsfile: Data/hofx/new/aircraft_letkf-gfs_2020121500_m.nc4
          obsfile: Data/obs/testinput_tier_1/aircraft_obs_2020121500_m.nc4
#         obsfile: Data/hofx/aircraft_letkf-gfs_2020121500_m.nc4
      obsdataout:
        engine:
          type: H5File
          obsfile: Data/hofx/aircraft_letkf-member%ensmem%-gfs_2020121500_m.nc4
      io pool:
        max pool size: 1
        write multiple files: false
      simulated variables: [windEastward,windNorthward,airTemperature]
    obs operator:
      name: VertInterp
      vertical coordinate: air_pressure
      observation vertical coordinate: pressure
#     constant vertical coordinate values: [1.2935175169939301, 2.0560170792448735, 3.2099780369050297, 4.9244806732419182, 7.4260366973539753, 11.013543585839802, 16.071500137597411, 23.083787868446535, 32.648386654790954, 45.488310100060332, 62.460697526384763, 84.561317895515486, 112.92219232016193, 148.80204275141409, 193.57229762559558, 248.69514527559113, 315.69253359218862, 396.1115521407678, 491.48597082105607, 603.29414569570838, 732.91755275460696, 881.60202101128459, 1050.4251776487108, 1240.2720271868166, 1451.8169455507925, 1685.519366494583, 1941.6314328912401, 2220.2141067067346, 2521.1695789439145, 2844.281277684192, 3189.26429058338, 3555.8235721907063, 3943.7179395282828, 4352.8305973202678, 4783.2411552433359, 5235.3026202107412, 5709.7193590381812, 6207.6280350649495, 6730.6822040805109, 7280.9801183099507, 7860.3754245775017, 8470.1714484625445, 9111.5319937207078, 9785.6051896380304, 10493.515338137269, 11236.357871974882, 12015.187800601701, 12831.006019807901, 13684.753130455094, 14577.296446754626, 15509.415719028097, 16481.793919538628, 17495.000854621474, 18549.482791124996, 19645.549693156354, 20783.360624546462, 21962.912418976262, 23184.020358576669, 24446.314118642505, 25749.223809068222, 27091.962477251367, 28473.521850164223, 29892.673147688227, 31347.968196387614, 32837.734253795679, 34360.079963862401, 35912.9035919577, 37493.900382114225, 39100.56206172047, 40730.190954509519, 42379.928743671015, 44046.770141571556, 45727.568100461067, 47419.04976343998, 49117.860488583159, 50820.579110925792, 52523.724837372443, 54223.821528655244, 55917.453189463195, 57601.269873001002, 59271.997271040222, 60926.460552080949, 62561.601889130972, 64174.509936093702, 65762.443226751115, 67322.837665947474, 68853.3191285824, 70351.734150544391, 71816.171235733011, 73244.953298280394, 74636.63137077124, 75989.984868116531, 77304.019985629289, 78577.951877050349, 79811.209605796219, 81003.410119594759, 82154.346759915643, 83263.984124197086, 84332.43799907573, 85359.956632884554, 86346.932463932884, 87293.895375129287, 88201.463141950357, 89070.353478934732, 89901.37697469609, 90695.515852671408, 91453.577028753658, 92176.407533925652, 92865.21472901394, 93521.070459526192, 94145.009661751552, 94738.147410867226, 95301.567790968489, 95836.383145647647, 96343.679354660824, 96824.531097769708, 97280.056348812825, 97711.372091846322, 98119.571775310673, 98505.706679467898, 98870.799047344743, 99215.851778849174, 99541.834120665168, 99849.685975629851, 100140.3127679535, 100414.58133641056, 100673.34640908921]
      observation vertical coordinate group: MetaData
      interpolation method: log-linear
    obs error:
      covariance model: diagonal
    obs filters:
    - filter: PreQC
      maxvalue: 3
    - filter: Background Check
      filter variables:
      - name: windEastward
      - name: windNorthward
      - name: airTemperature
      threshold: 6.0
    obs localizations:
    - localization method: Horizontal Gaspari-Cohn
      lengthscale: 5000e3
      max nobs: 50

driver:
  save posterior ensemble: true
  save posterior mean: true
  save posterior mean increment: true
  save posterior ensemble increments: true
  read HX from disk: false
  do test prints: true
  do posterior observer: true
  run as observer only: false
local ensemble DA:
  solver: LETKF
  inflation:
    rtps: 0.5
    rtpp: 0.6
    mult: 1.1

# for realistic output, use gfs filetype for output
# here we are using latlon for ease of visualisation
output:
  filetype: auxgrid
  gridtype: latlon
  filename: Data/analysis/letkf/gfs/mem%{member}%/letkf.

output increment:
  filetype: auxgrid
  gridtype: latlon
  filename: Data/analysis/letkf/gfs/mem%{member}%/xainc.

output ensemble increments: 
  filetype: auxgrid
  gridtype: latlon
  filename: Data/analysis/letkf/gfs/mem%{member}%/ensinc.
#test:
#  reference filename: testoutput/letkf.ref
#  test output filename: testoutput/letkf.test.out
#  float relative tolerance: 1.0e-3

